name: Release & Versioning

on:
  push:
    branches:
      - main
    paths:
      - '*/*/main.tf'
      - '*/*/variables.tf'
      - '*/*/outputs.tf'

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@21 \
            @semantic-release/git@10 \
            @semantic-release/changelog@6 \
            @semantic-release/github@9

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release

  update-terraform-registry:
    name: Update Terraform Registry
    runs-on: ubuntu-latest
    needs: semantic-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify Terraform Registry
        run: |
          echo "ðŸ“¦ New version published - Terraform Registry will auto-sync"
          echo "Visit: https://registry.terraform.io/modules/Sumanth12-afk/startup-infrastructure/aws"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: semantic-release
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ðŸš€ Release ${{ steps.get_version.outputs.VERSION }}
          
          ## ðŸ“¦ What's Changed
          
          This release includes updates to AWS Startup Terraform Modules.
          
          ## ðŸ—ï¸ Modules Included
          
          - **Networking**: VPC, ALB, NAT Gateway
          - **Compute**: ECS Fargate, Lambda API Gateway
          - **Storage**: RDS PostgreSQL (in progress)
          
          ## ðŸ“– Documentation
          
          - [Getting Started](./GETTING_STARTED.md)
          - [Implementation Guide](./IMPLEMENTATION_GUIDE.md)
          - [Project Status](./PROJECT_STATUS.md)
          
          ## ðŸ”’ Security
          
          - All modules follow AWS Well-Architected Framework
          - Encryption enabled by default
          - Least-privilege IAM policies
          
          ## ðŸ’° Cost Optimization
          
          - Fargate Spot support (70% savings)
          - Right-sized defaults
          - Auto-scaling policies
          
          ## ðŸ†• Installation
          
          \`\`\`hcl
          module "vpc" {
            source  = "Sumanth12-afk/startup-infrastructure/aws//networking/vpc-networking"
            version = "${{ steps.get_version.outputs.VERSION }}"
            
            environment = "production"
            vpc_cidr    = "10.0.0.0/16"
          }
          \`\`\`
          
          ## ðŸ“ž Support
          
          - [GitHub Issues](https://github.com/Sumanth12-afk/aws-startup-terraform-modules/issues)
          - [Discussions](https://github.com/Sumanth12-afk/aws-startup-terraform-modules/discussions)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

